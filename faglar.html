<!doctype html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fåglar jag sett</title>
</head>
<style>
  body {
      height: 100%;
      margin: 0;
  }
  #addbird {
      position: fixed;
      right: 0;
      bottom: 0;
      left: 0;
      background: grey;
  }
  #addbird input {
      width: calc(100% - 2rem);
      margin: 1rem;
      padding: 0.3em;
      box-sizing: border-box;
  }
</style>
<body>
    <div id="app">
        <div id="addbird">
            <input type="text" list="birds" @change="addObservation($event)" autocomplete="off"/>
        </div>

        <h2>Samtliga observationer</h2>
        <ul>
            <li v-for="(bird, index) in allBirdObservations" :key="index">
                {{ bird.name }} <button type="button" @click.prevent="deleteObservation(bird.id)">x</button>
            </li>
        </ul>

        <h2>Allt i {{ localDate(new Date(), { year: 'numeric', month: 'long' }) }}</h2>
        <ul>
            <li v-for="bird in allThisMonth">
                {{ bird.name }}
                {{ localDate(bird.date) }}
            </li>
        </ul>

        <h2>{{ uniqueThisMonth.length }} unika i {{ localDate(new Date(), { month: 'long' }) }}</h2>
        <ul>
            <li v-for="bird in uniqueThisMonth">
                {{ bird }}
            </li>
        </ul>
    </div>
    <datalist id="birds">
        <option>Aftonfalk</option>
        <option>Alfågel</option>
        <option>Alförrädare</option>
        <option>Alkekung</option>
        <option>Alpjärnsparv</option>
        <option>Alpkaja</option>
        <option>Alpkråka</option>
        <option>Alpseglare</option>
        <option>Amerikansk kopparand</option>
        <option>Backsvala</option>
        <option>Balkanhök</option>
        <option>Balkanmes</option>
        <option>Balkanspett</option>
        <option>Bergand</option>
        <option>Bergfink</option>
        <option>Berghöna</option>
        <option>Berglärka</option>
        <option>Bergsångare</option>
        <option>Berguv</option>
        <option>Bivråk</option>
        <option>Biätare</option>
        <option>Björktrast</option>
        <option>Blektornseglare</option>
        <option>Blå kärrhök</option>
        <option>Blåhake</option>
        <option>Blåkråka</option>
        <option>Blåmes</option>
        <option>Blåskata</option>
        <option>Blåtrast</option>
        <option>Bläsand</option>
        <option>Bläsgås</option>
        <option>Bofink</option>
        <option>Brandkronad kungsfågel</option>
        <option>Brednäbbadsimsnäppa</option>
        <option>Bredstjärtad labb</option>
        <option>Bronsibis</option>
        <option>Brun kärrhök</option>
        <option>Brunand</option>
        <option>Brunglada</option>
        <option>Brushane</option>
        <option>Buskskvätta</option>
        <option>Busksångare</option>
        <option>Bändelkorsnäbb</option>
        <option>Cettisångare</option>
        <option>Citronsiska</option>
        <option>Citronärla</option>
        <option>Dalripa</option>
        <option>Dammsnäppa</option>
        <option>Diamantfasan</option>
        <option>Domherre</option>
        <option>Drillsnäppa</option>
        <option>Dubbelbeckasin</option>
        <option>Dubbeltrast</option>
        <option>Duvhök</option>
        <option>Dvärg lira</option>
        <option>Dvärgbeckasin</option>
        <option>Dvärglärka</option>
        <option>Dvärgmås</option>
        <option>Dvärgrördrom</option>
        <option>Dvärgskarv</option>
        <option>Dvärgsparv</option>
        <option>Dvärgsumphöna</option>
        <option>Dvärguv</option>
        <option>Dvärgörn</option>
        <option>Ejder</option>
        <option>Eksångare</option>
        <option>Eleonorafalk</option>
        <option>Enkelbeckasin</option>
        <option>Entita</option>
        <option>Fasan</option>
        <option>Fiskgjuse</option>
        <option>Fiskmås</option>
        <option>Fisktärna</option>
        <option>Fjällabb</option>
        <option>Fjällgås</option>
        <option>Fjällpipare</option>
        <option>Fjällripa</option>
        <option>Fjälluggla</option>
        <option>Fjällvråk</option>
        <option>Flamingo</option>
        <option>Flodsångare</option>
        <option>Forsärla</option>
        <option>Fältpiplärka</option>
        <option>Glada</option>
        <option>Glasögonsångare</option>
        <option>Gluttsnäppa</option>
        <option>Gransångare</option>
        <option>Gravand</option>
        <option>Grå flugsnappare</option>
        <option>Grågam</option>
        <option>Grågås</option>
        <option>Gråhakedopping</option>
        <option>Grålira</option>
        <option>Gråsiska</option>
        <option>Gråsparv</option>
        <option>Gråspett</option>
        <option>Gråtrut</option>
        <option>Gräsand</option>
        <option>Gräshoppssångare</option>
        <option>Grässångare</option>
        <option>Grönbena</option>
        <option>Grönfink</option>
        <option>Gröngöling</option>
        <option>Grönsiska</option>
        <option>Grönsångare</option>
        <option>Guldfasan</option>
        <option>Gulhämpling</option>
        <option>Gulnäbbad Lira</option>
        <option>Gulsparv</option>
        <option>Gulärla</option>
        <option>Gyllensparv</option>
        <option>Gåsgam</option>
        <option>Gärdesmyg</option>
        <option>Gök</option>
        <option>Göktyta</option>
        <option>Halsbandsflugsnappare</option>
        <option>Halsbandsparakit</option>
        <option>Havssula</option>
        <option>Havstrut</option>
        <option>Havsörn</option>
        <option>Hornuggla</option>
        <option>Hussvala</option>
        <option>Häcksparv</option>
        <option>Häger</option>
        <option>Hämpling</option>
        <option>Härfågel</option>
        <option>Härmsångare</option>
        <option>Höksångare</option>
        <option>Hökuggla</option>
        <option>Hökörn</option>
        <option>Islandsknipa</option>
        <option>Islom</option>
        <option>Jaktfalk</option>
        <option>Jorduggla</option>
        <option>Järnsparv</option>
        <option>Järpe</option>
        <option>Kaja</option>
        <option>Kalenderlärka</option>
        <option>Kamsothöna</option>
        <option>Kanadagås</option>
        <option>Kattuggla</option>
        <option>Kaveldunssångare</option>
        <option>Kejsarörn</option>
        <option>Kentsk tärna</option>
        <option>Klippduva</option>
        <option>Klipphöna</option>
        <option>Klippnötväcka</option>
        <option>Klippsparv</option>
        <option>Klippsvala</option>
        <option>Klyvstjärtad Stormsvala</option>
        <option>Knipa</option>
        <option>Knölsvan</option>
        <option>Kohäger</option>
        <option>Koltrast</option>
        <option>Kopparand</option>
        <option>Kornknarr</option>
        <option>Kornsparv</option>
        <option>Korp</option>
        <option>Korsikansk nötväcka</option>
        <option>Korttålärka</option>
        <option>Kricka</option>
        <option>Krushuvad Pelikan</option>
        <option>Kråka</option>
        <option>Kungsfiskare</option>
        <option>Kungsfågel</option>
        <option>Kungsörn</option>
        <option>Kustpipare</option>
        <option>Kustsnäppa</option>
        <option>Kärrsnäppa</option>
        <option>Kärrsångare</option>
        <option>Labb</option>
        <option>Ladusvala</option>
        <option>Lagerlärka</option>
        <option>Lammgam</option>
        <option>Lappmes</option>
        <option>Lappsparv</option>
        <option>Lappuggla</option>
        <option>Lavskrika</option>
        <option>Ljungpipare</option>
        <option>Lundsångare</option>
        <option>Lunnefågel</option>
        <option>Långnäbbad mås</option>
        <option>Lärkfalk</option>
        <option>Lövsångare</option>
        <option>Madeiran Stormsvala</option>
        <option>Mandarinand</option>
        <option>Marmorand</option>
        <option>Masktörnskata</option>
        <option>Medelhavsstenskvätta</option>
        <option>Mellanspett</option>
        <option>Mindre flugsnappare</option>
        <option>Mindre Hackspett</option>
        <option>Mindre Iltärna</option>
        <option>Mindre korsnäbb</option>
        <option>Mindre lira</option>
        <option>Mindre Skrikörn</option>
        <option>Mindre strandpipare</option>
        <option>Mindre Sumphöna</option>
        <option>Mindre Sångsvan</option>
        <option>Minervauggla</option>
        <option>Morkulla</option>
        <option>Mosnäppa</option>
        <option>Murkrypare</option>
        <option>Myrsnäppa</option>
        <option>Myrspov</option>
        <option>Mästersångare</option>
        <option>Natthäger</option>
        <option>Nattskärra</option>
        <option>Nilgås</option>
        <option>Nordsångare</option>
        <option>Näktergal</option>
        <option>Nötkråka</option>
        <option>Nötskrika</option>
        <option>Nötväcka</option>
        <option>Olivsångare</option>
        <option>Ormvråk</option>
        <option>Ormörn</option>
        <option>Orre</option>
        <option>Ortolansparv</option>
        <option>Pelikan</option>
        <option>Pilfink</option>
        <option>Pilgrimsfalk</option>
        <option>Polygottsångare</option>
        <option>Provencesångare</option>
        <option>Prutgås</option>
        <option>Pungmes</option>
        <option>Purpurhäger</option>
        <option>Purpurhöna</option>
        <option>Pärluggla</option>
        <option>Rallhäger</option>
        <option>Rapphöna</option>
        <option>Ringduva</option>
        <option>Ringnäbbad mås</option>
        <option>Ringtrast</option>
        <option>Rosenfink</option>
        <option>Rosenstare</option>
        <option>Rosentärna</option>
        <option>Roskarl</option>
        <option>Rostand</option>
        <option>Rostgumpsvala</option>
        <option>Rostsparv</option>
        <option>Råka</option>
        <option>Rödbena</option>
        <option>Rödfalk</option>
        <option>Rödhake</option>
        <option>Rödhalsad nattskärra</option>
        <option>Rödhalsadgås</option>
        <option>Rödhuvad dykand</option>
        <option>Rödhuvad törnskata</option>
        <option>Rödhöna</option>
        <option>Rödnäbbad trut</option>
        <option>Rödspov</option>
        <option>Rödstjärt</option>
        <option>Rödstrupig sångare</option>
        <option>Rödstrupigpiplärka</option>
        <option>Rödvingetrast</option>
        <option>Rördrom</option>
        <option>Rörhöna</option>
        <option>Rörsångare</option>
        <option>Salskrake</option>
        <option>Sammetshätta</option>
        <option>Sandlöpare</option>
        <option>Sandtärna</option>
        <option>Sardinsksångare</option>
        <option>Sidensvans</option>
        <option>Silkeshäger</option>
        <option>Sillgrissla</option>
        <option>Silltrut</option>
        <option>Silvertärna</option>
        <option>Sjöorre</option>
        <option>Skata</option>
        <option>Skatgök</option>
        <option>Skedand</option>
        <option>Skedstork</option>
        <option>Skogsduva</option>
        <option>Skogssnäppa</option>
        <option>Skotsk Korsnäbb</option>
        <option>Skrattmås</option>
        <option>Skräntärna</option>
        <option>Skäggdopping</option>
        <option>Skäggmes</option>
        <option>Skäggtärna</option>
        <option>Skärfläcka</option>
        <option>Skärpiplärka</option>
        <option>Skärsnäppa</option>
        <option>Slagfalk</option>
        <option>Slaguggla</option>
        <option>Smalnäbbadsimsnäppa</option>
        <option>Smutsgam</option>
        <option>Smådopping</option>
        <option>Småfläckigsumphöna</option>
        <option>Smålom</option>
        <option>Småskrake</option>
        <option>Småsnäppa</option>
        <option>Småspov</option>
        <option>Småtrapp</option>
        <option>Småtärna</option>
        <option>Snatterand</option>
        <option>Snöfink</option>
        <option>Snösiska</option>
        <option>Snösparv</option>
        <option>Sommargylling</option>
        <option>Sothöna</option>
        <option>Spansksparv</option>
        <option>Sparvhök</option>
        <option>Sparvuggla</option>
        <option>Spetsbergsgrissla</option>
        <option>Spetsbergsgås</option>
        <option>Spillkråka</option>
        <option>Sporrvipa</option>
        <option>Spovsnäppa</option>
        <option>Stare</option>
        <option>Steglits</option>
        <option>Stenfalk</option>
        <option>Stenhöna</option>
        <option>Stenknäck</option>
        <option>Stenskvätta</option>
        <option>Stensparv</option>
        <option>Stentrast</option>
        <option>Stjärtand</option>
        <option>Stjärtmes</option>
        <option>Storlabb</option>
        <option>Storlom</option>
        <option>Stormfågel</option>
        <option>Stormsvala</option>
        <option>Storskarv</option>
        <option>Storskrake</option>
        <option>Storspov</option>
        <option>Stortrapp</option>
        <option>Strandskata</option>
        <option>Strömand</option>
        <option>Strömstare</option>
        <option>Styltlöpare</option>
        <option>Stäpphök</option>
        <option>Större Hackspett</option>
        <option>Större korsnäbb</option>
        <option>Större Lira</option>
        <option>Större Skrikörn</option>
        <option>Större strandpipare</option>
        <option>Svart Stare</option>
        <option>Svart stenskvätta</option>
        <option>Svart stork</option>
        <option>Svartbent strandpipare</option>
        <option>Svartbukig flyghöna</option>
        <option>Svarthakad buskskvätta</option>
        <option>Svarthakedopping</option>
        <option>Svarthalsaddopping</option>
        <option>Svarthuvad sparv</option>
        <option>Svarthuvadmås</option>
        <option>Svarthätta</option>
        <option>Svartmes</option>
        <option>Svartpannadtörnskata</option>
        <option>Svartrödstjärt</option>
        <option>Svartsnäppa</option>
        <option>Svarttärna</option>
        <option>Svartvingad glada</option>
        <option>Svartvit flugsnappare</option>
        <option>Svärta</option>
        <option>Sydnäcktergal</option>
        <option>Sånglärka</option>
        <option>Sångsvan</option>
        <option>Sädesärla</option>
        <option>Sädgås</option>
        <option>Sävsparv</option>
        <option>Sävsångare</option>
        <option>Taigasångare</option>
        <option>Talgoxe</option>
        <option>Tallbit</option>
        <option>Talltita</option>
        <option>Taltrast</option>
        <option>Tatarfalk</option>
        <option>Tereksnäppa</option>
        <option>Tjockfot</option>
        <option>Tjäder</option>
        <option>Tobisgrissla</option>
        <option>Tofslärka</option>
        <option>Tofsmes</option>
        <option>Tofsvipa</option>
        <option>Toppskarv</option>
        <option>Tordmule</option>
        <option>Tornfalk</option>
        <option>Tornseglare</option>
        <option>Tornuggla</option>
        <option>Trana</option>
        <option>Trastsångare</option>
        <option>Tretåig Hackspett</option>
        <option>Tretåig mås</option>
        <option>Trädgårdssångare</option>
        <option>Trädgårdsträdkrypare</option>
        <option>Trädkrypare</option>
        <option>Trädlärka</option>
        <option>Trädmås</option>
        <option>Trädnäcktergal</option>
        <option>Trädpiplärka</option>
        <option>Turkduva</option>
        <option>Turturduva</option>
        <option>Tuvsnäppa</option>
        <option>Tärnmås</option>
        <option>Törnskata</option>
        <option>Törnsångare</option>
        <option>Vadarsvala</option>
        <option>Vaktel</option>
        <option>Varfågel</option>
        <option>Vassångare</option>
        <option>Vattenpiplärka</option>
        <option>Vattenrall</option>
        <option>Vattensångare</option>
        <option>Videsparv</option>
        <option>Vigg</option>
        <option>Wilson's simsnäppa</option>
        <option>Wilson's Stormsvala</option>
        <option>Vinterhämpling</option>
        <option>Vit stork</option>
        <option>Vitbukig flyghöna</option>
        <option>Vitkindadgås</option>
        <option>Vitnäbbad Islom</option>
        <option>Vitryggig Hackspett</option>
        <option>Vittrut</option>
        <option>Vitvingad tärna</option>
        <option>Vitvingadtrut</option>
        <option>Vitögd dykand</option>
        <option>Årta</option>
        <option>Ägretthäger</option>
        <option>Ängshök</option>
        <option>Ängspiplärka</option>
        <option>Ärtsångare</option>
        <option>Örnvråk</option>
    </datalist>

    <script src="https://unpkg.com/vue@2"></script>

    <script>
    var app = new Vue({
        el: '#app',
        data() {
          return {
              allBirdObservations: []
          }
        },
        computed: {
            allThisMonth() {
                return this.allBirdObservations.filter(obs => obs.date.getFullYear() == new Date().getFullYear() && obs.date.getMonth() == new Date().getMonth())
            },
            uniqueThisMonth() {
                return [...new Set(this.allThisMonth.map(item => item.name))].sort();
            }
        },
        methods: {
            localDate(date, config) {
                let lang = document.documentElement.lang || 'sv';
                let options = config ? config : { dateStyle: 'full', timeStyle: 'short' };
                return new Intl.DateTimeFormat(lang, options).format(date);
            },
            addObservation(ev) {
                let transaction = this.db.transaction("observations", "readwrite");
                let observations = transaction.objectStore("observations");
                let observation = {
                    id: Math.random(),
                    name: ev.target.value,
                    date: new Date()
                };
                let addRequest = observations.add(observation);

                addRequest.onsuccess = () => {
                    this.allBirdObservations.push(observation);
                    ev.target.value = ''; // reset form field value
                };

                addRequest.onerror = () => {
                    console.log("Error", addRequest.error);
                };
            },
            deleteObservation(id) {
                let transaction = this.db.transaction("observations", "readwrite");
                let observations = transaction.objectStore("observations");
                let getRequest = observations.getKey(id);

                getRequest.onsuccess = () => {
                    let id = getRequest.result;
                    let deleteRequest = observations.delete(id);
                    deleteRequest.onsuccess = () => {
                        this.getObservations();
                    }
                };
            },
            getObservations() {
                let transaction = this.db.transaction("observations", "readonly");
                let observations = transaction.objectStore("observations");
                let request = observations.getAll();

                request.onsuccess = () => {
                    this.allBirdObservations = request.result || [];
                };
            }
        },
        created() {
            let openRequest = indexedDB.open("birdlist", 1);

            openRequest.onupgradeneeded = () => {
                // triggers if the client had no database
                this.db = openRequest.result;
                if (!this.db.objectStoreNames.contains('observations')) { // if there's no "observations" store
                    this.db.createObjectStore('observations', { keyPath: 'id' }); // create it
                }
            };

            openRequest.onerror = () => {
                console.error("Error", openRequest.error);
            };

            openRequest.onsuccess = () => {
                this.db = openRequest.result;

                this.db.onversionchange = () => {
                    this.db.close();
                    alert("Database is outdated, please reload the page.")
                };

                this.getObservations();
            };
        }
    });
    </script>
</body>
</html>
